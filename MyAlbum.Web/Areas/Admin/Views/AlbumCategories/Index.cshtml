
@{
    ViewData["Title"] = "相簿類別管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div id="app" class="p-3">
    <el-card shadow="never">
        <template #header>
            <div style="display:flex; flex-direction:column; gap:12px;">

                <!-- 第一行：標題 -->
                <div style="font-size:16px; font-weight:600;">
                    相簿類別管理
                </div>

                <!-- 第二行：左查詢區 + 右新增按鈕 -->
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">

                    <!-- 左側：查詢條件 -->
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">

                        <el-input v-model="query.categoryName"
                                  placeholder="搜尋類別名稱"
                                  clearable
                                  style="width:260px;">
                        </el-input>

                        <el-select v-model="query.statusFilter"
                                   placeholder="狀態"
                                   clearable
                                   style="width:140px;">
                            <el-option label="全部" :value="null"></el-option>
                            <el-option label="啟用" :value="statusValues.enabled"></el-option>
                            <el-option label="停用" :value="statusValues.disabled"></el-option>
                        </el-select>

                        <el-button v-on:click="onSearch">查詢</el-button>
                        <el-button v-on:click="resetQuery">清除</el-button>

                    </div>

                    <!-- 右側：新增按鈕 -->
                    <div>
                        <el-button type="primary" v-on:click="openCreate">
                            新增
                        </el-button>
                    </div>

                </div>
            </div>
        </template>

        <!-- Table -->
        <el-table :data="rows" v-loading="loading" border style="width:100%;">
            <el-table-column prop="categoryName" label="類別名稱" min-width="260"></el-table-column>
            <el-table-column prop="sortOrder" label="排序" width="120"></el-table-column>

            <el-table-column label="狀態" width="140">
                <template #default="scope">
                    <el-tag v-if="isEnabled(scope.row.status)" type="success">啟用</el-tag>
                    <el-tag v-else type="info">停用</el-tag>
                </template>
            </el-table-column>

            <el-table-column label="操作" width="300">
                <template #default="scope">
                    <el-button size="small" v-on:click="openEdit(scope.row)">更新</el-button>

                    <el-button size="small"
                               type="danger"
                               :disabled="!isEnabled(scope.row.status)"
                               v-on:click="confirmSetStatus(scope.row, statusValues.disabled)">
                        停用
                    </el-button>

                    <el-button size="small"
                               type="success"
                               :disabled="isEnabled(scope.row.status)"
                               v-on:click="confirmSetStatus(scope.row, statusValues.enabled)">
                        啟用
                    </el-button>
                </template>
            </el-table-column>
        </el-table>

        <!-- Pagination -->
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <el-pagination background
                           layout="total, sizes, prev, pager, next, jumper"
                           :total="pager.total"
                           :page-size="pager.pageSize"
                           :current-page="pager.pageIndex"
                           :page-sizes="[10, 20, 50, 100]"
                           v-on:current-change="onPageChange"
                           v-on:size-change="onSizeChange">
            </el-pagination>
        </div>
    </el-card>

    <!-- Dialog：Create / Edit -->
    <el-dialog v-model="dialog.visible"
               :title="dialog.mode === 'create' ? '新增類別' : '更新類別'"
               width="560px">

        <el-form :model="form" label-width="90px">
            <el-form-item label="類別名稱">
                <el-input v-model="form.categoryName" placeholder="請輸入類別名稱"></el-input>
            </el-form-item>

            <el-form-item label="排序">
                <el-input v-model.number="form.sortOrder" type="number" placeholder="請輸入排序"></el-input>
            </el-form-item>

            <el-form-item v-if="dialog.mode === 'edit'" label="狀態">
                <el-select v-model="form.status" style="width:100%;">
                    <el-option label="啟用" :value="statusValues.enabled"></el-option>
                    <el-option label="停用" :value="statusValues.disabled"></el-option>
                </el-select>
            </el-form-item>
        </el-form>

        <template #footer>
            <el-button v-on:click="dialog.visible=false">取消</el-button>
            <el-button type="primary" :loading="dialog.saving" v-on:click="saveDialog">儲存</el-button>
        </template>
    </el-dialog>
</div>

<script>
    const { createApp, reactive, ref, onMounted } = Vue;

    createApp({
        setup() {
            const loading = ref(false);
            const rows = ref([]);

            // Status enum：1=啟用, 0=停用
            const statusValues = {
                enabled: 1,
                disabled: 0
            };

            // 查詢條件
            const query = reactive({
                categoryName: '',
                statusFilter: null // null=全部
            });

            // 分頁
            const pager = reactive({
                pageIndex: 1,
                pageSize: 10,
                total: 0
            });

            // Dialog
            const dialog = reactive({
                visible: false,
                mode: 'create', // create | edit
                saving: false
            });

            // Form
            const form = reactive({
                albumCategoryId: null,
                categoryName: '',
                sortOrder: 1,
                status: statusValues.enabled
            });

            const api = axios.create({
                baseURL: '/Admin/Api/AlbumCategoriesApi',
                headers: { 'Content-Type': 'application/json' }
            });

            function isEnabled(status) {
                return status === statusValues.enabled;
            }

            // List：GET /Admin/Api/AlbumCategoriesApi?pageIndex=1&pageSize=10&Data.CategoryName=xx&Data.Status=1
            async function loadList() {
                loading.value = true;
                try {
                    const resp = await api.get('', {
                        params: {
                            pageIndex: pager.pageIndex,
                            pageSize: pager.pageSize,
                            'Data.CategoryName': query.categoryName || null,
                            'Data.Status': query.statusFilter
                        }
                    });

                    const payload = resp.data || {};
                    rows.value = payload.data ?? payload.Data ?? [];
                    pager.total = payload.count ?? payload.Count ?? 0;
                } catch (e) {
                    ElementPlus.ElMessage.error('載入列表失敗');
                } finally {
                    loading.value = false;
                }
            }

            function onSearch() {
                pager.pageIndex = 1;
                loadList();
            }

            function resetQuery() {
                query.categoryName = '';
                query.statusFilter = null;
                pager.pageIndex = 1;
                loadList();
            }

            function onPageChange(page) {
                pager.pageIndex = page;
                loadList();
            }

            function onSizeChange(size) {
                pager.pageSize = size;
                pager.pageIndex = 1;
                loadList();
            }

            function openCreate() {
                dialog.mode = 'create';
                form.albumCategoryId = null;
                form.categoryName = '';
                form.sortOrder = 1;
                form.status = statusValues.enabled;
                dialog.visible = true;
            }

            async function openEdit(row) {
                dialog.mode = 'edit';
                dialog.visible = true;
                dialog.saving = false;

                try {
                    const resp = await api.get(`/${row.albumCategoryId}`);
                    const dto = resp.data;

                    form.albumCategoryId = dto.albumCategoryId ?? dto.AlbumCategoryId;
                    form.categoryName = dto.categoryName ?? dto.CategoryName;
                    form.sortOrder = dto.sortOrder ?? dto.SortOrder;
                    form.status = dto.status ?? dto.Status;
                } catch (e) {
                    ElementPlus.ElMessage.error('讀取資料失敗');
                    dialog.visible = false;
                }
            }

            async function saveDialog() {
                if (!form.categoryName || !form.categoryName.trim()) {
                    ElementPlus.ElMessage.warning('類別名稱必填');
                    return;
                }
                if (form.sortOrder === null || form.sortOrder === undefined || Number.isNaN(form.sortOrder)) {
                    ElementPlus.ElMessage.warning('類別排序必填');
                    return;
                }

                dialog.saving = true;
                try {
                    if (dialog.mode === 'create') {
                        await api.post('', {
                            categoryName: form.categoryName,
                            sortOrder: form.sortOrder
                        });

                        ElementPlus.ElMessage.success('新增成功');
                        dialog.visible = false;
                        loadList();
                    } else {
                        await api.put(`/${form.albumCategoryId}`, {
                            albumCategoryId: form.albumCategoryId,
                            categoryName: form.categoryName,
                            sortOrder: form.sortOrder,
                            status: form.status
                        });

                        ElementPlus.ElMessage.success('更新成功');
                        dialog.visible = false;
                        loadList();
                    }
                } catch (e) {
                    ElementPlus.ElMessage.error('儲存失敗（請檢查欄位或後端驗證）');
                } finally {
                    dialog.saving = false;
                }
            }

            async function confirmSetStatus(row, newStatus) {
                const actionText = (newStatus === statusValues.disabled) ? '停用' : '啟用';

                try {
                    await ElementPlus.ElMessageBox.confirm(
                        `確定要${actionText}「${row.categoryName}」？`,
                        `${actionText}確認`,
                        { type: 'warning' }
                    );

                    const resp = await api.patch(`/${row.albumCategoryId}/status`, {
                        status: newStatus
                    });

                    const ok = resp.data === true || resp.data === "true";
                    if (ok) {
                        row.status = newStatus;
                        ElementPlus.ElMessage.success(`${actionText}成功`);
                    } else {
                        ElementPlus.ElMessage.error(`${actionText}失敗`);
                    }
                } catch {
                    // cancel / ignore
                }
            }

            onMounted(loadList);

            return {
                loading,
                rows,
                query,
                pager,
                dialog,
                form,
                statusValues,
                isEnabled,
                loadList,
                onSearch,
                resetQuery,
                onPageChange,
                onSizeChange,
                openCreate,
                openEdit,
                saveDialog,
                confirmSetStatus
            };
        }
    }).use(ElementPlus).mount('#app');
</script>
