
@{
    ViewData["Title"] = "相簿相片管理";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div id="app" class="p-3">
    <el-card shadow="never">
        <template #header>
            <div style="display:flex; flex-direction:column; gap:16px;">

                <!-- 第一行：標題 + 新增 -->
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:16px; font-weight:600;">
                        相簿相片管理
                    </div>

                    <el-button type="primary" v-on:click="openCreate">
                        新增
                    </el-button>
                </div>

                <!-- 第二行：查詢表單 -->
                <el-form :inline="true"
                         :model="query"
                         class="album-search-form"
                         style="width:100%;">

                    <el-form-item label="擁有人">
                        <!-- 擁有人的下拉選單 -->
                        <el-select v-model="query.ownerAccountId"
                                   placeholder="擁有人"
                                   clearable
                                   filterable
                                   :loading="ownerLoading"
                                   style="width:220px;"
                                   v-on:change="onOwnerChanged">
                            <el-option label="全部" :value="null"></el-option>
                            <el-option v-for="o in ownerItems"
                                       :key="o.accountId"
                                       :label="o.displayName"
                                       :value="o.accountId" />
                        </el-select>
                    </el-form-item>

                    <el-form-item label="相簿">
                        <!--相簿的下拉選單 -->
                        <el-select v-model="query.albumId"
                                   placeholder="擁有人的相簿"
                                   clearable
                                   filterable
                                   :loading="albumLoading"
                                   style="width:220px;">
                            <el-option label="全部" :value="null"></el-option>
                            <el-option v-for="a in albumItems"
                                       :key="a.albumId"
                                       :label="a.title"
                                       :value="a.albumId" />
                        </el-select>
                    </el-form-item>

                    <el-form-item label="狀態">
                        <el-select v-model="query.statusFilter"
                                   placeholder="狀態"
                                   clearable
                                   style="width:140px;">
                            <el-option label="全部" :value="null"></el-option>
                            <el-option label="啟用" :value="statusValues.enabled"></el-option>
                            <el-option label="停用" :value="statusValues.disabled"></el-option>
                        </el-select>
                    </el-form-item>

                    <!-- 查詢 / 清除 -->
                    <el-form-item class="search-buttons">
                        <el-button type="primary" v-on:click="onSearch">查詢</el-button>
                        <el-button v-on:click="resetQuery">清除</el-button>
                    </el-form-item>

                </el-form>
            </div>
        </template>

        <!-- Table -->
        <el-table :data="rows" v-loading="loading" border style="width:100%;">
            <el-table-column prop="ownerName" label="擁有人" min-width="80"></el-table-column>
            <el-table-column prop="title" label="相簿" min-width="150"></el-table-column>
            <el-table-column prop="publicPathUrl" label="相片" min-width="150">
                <template #default="scope">
                    <el-image v-if="scope.row.publicPathUrl"
                              :src="scope.row.publicPathUrl"
                              style="width:72px; height:72px; border-radius:6px;"
                              fit="cover"
                              :preview-src-list="[scope.row.publicPathUrl]"
                              preview-teleported />
                </template>
            </el-table-column>
            <el-table-column prop="sortOrder" label="排序" min-width="50"></el-table-column>
            <el-table-column label="狀態" width="140">
                <template #default="scope">
                    <el-tag v-if="isEnabled(scope.row.status)" type="success">啟用</el-tag>
                    <el-tag v-else type="info">停用</el-tag>
                </template>
            </el-table-column>

            <el-table-column label="操作" width="300">
                <template #default="scope">
                    <el-button size="small" v-on:click="openEdit(scope.row)">更新</el-button>

                    <el-button size="small"
                               type="danger"
                               :disabled="!isEnabled(scope.row.status)"
                               v-on:click="confirmSetStatus(scope.row, statusValues.disabled)">
                        停用
                    </el-button>

                    <el-button size="small"
                               type="success"
                               :disabled="isEnabled(scope.row.status)"
                               v-on:click="confirmSetStatus(scope.row, statusValues.enabled)">
                        啟用
                    </el-button>
                </template>
            </el-table-column>
        </el-table>

        <!-- Pagination -->
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <el-pagination background
                           layout="total, sizes, prev, pager, next, jumper"
                           :total="pager.total"
                           :page-size="pager.pageSize"
                           :current-page="pager.pageIndex"
                           :page-sizes="[10, 20, 50, 100]"
                           v-on:current-change="onPageChange"
                           v-on:size-change="onSizeChange">
            </el-pagination>
        </div>
    </el-card>

    <!-- Dialog：Create / Edit -->
    <el-dialog v-model="dialog.visible"
               :title="dialog.mode === 'create' ? '新增相簿相片' : '更新相簿相片'"
               width="560px">

        <el-form :model="form" label-width="90px">
            <!-- 擁有人：新增必填；更新時不可更換 -->
            <el-form-item label="擁有人" required v-if="dialog.mode === 'create'">
                <el-select v-model="form.ownerAccountId"
                           placeholder="請選擇擁有人"
                           filterable
                           :loading="formOwnerLoading"
                           style="width:100%;"
                           v-on:change="onFormOwnerChanged">
                    <el-option v-for="o in formOwnerItems"
                               :key="o.accountId"
                               :label="o.displayName"
                               :value="o.accountId" />
                </el-select>
            </el-form-item>
            
            <!-- 相簿：新增必填；更新時不可更換 -->
            <el-form-item label="相簿" required>
                <el-select v-model="form.albumId"
                           placeholder="請選擇相簿"
                           filterable
                           :loading="formAlbumLoading"
                           style="width:100%;"
                           :disabled="dialog.mode === 'edit'">
                    <el-option v-for="a in formAlbumItems"
                               :key="a.albumId"
                               :label="a.title"
                               :value="a.albumId" />
                </el-select>
            </el-form-item>
            <el-form-item label="排序" prop="sortOrder" v-if="dialog.mode === 'edit'">
                <el-input-number v-model="form.sortOrder"
                                 :min="0"
                                 :max="9999"
                                 :step="1"
                                 controls-position="right"
                                 style="width: 100%;" />
            </el-form-item>
            <!-- 新增：多檔上傳 -->
            <el-form-item v-if="dialog.mode === 'create'" label="相片" required>
                <el-upload v-model:file-list="createFileList"
                           action=""
                           :auto-upload="false"
                           :multiple="true"
                           :limit="5"
                           list-type="picture-card"
                           accept=".jpg,.jpeg,.png"
                           :before-upload="beforeImageUpload"
                           :on-exceed="onCreateExceed">
                    <span style="font-size:22px; line-height:1;">＋</span>
                    <template #tip>
                        <div class="el-upload__tip">僅允許 jpg / jpeg / png，最多 5 張</div>
                    </template>
                </el-upload>
            </el-form-item>

            <!-- 更新：單檔上傳（可不選） -->
            <el-form-item v-else label="重新上傳(選填)">
                <el-upload v-model:file-list="editFileList"
                           action=""
                           :auto-upload="false"
                           :multiple="false"
                           :limit="1"
                           list-type="picture-card"
                           accept=".jpg,.jpeg,.png"
                           :before-upload="beforeImageUpload"
                           :on-exceed="onEditExceed">
                    <span style="font-size:22px; line-height:1;">＋</span>
                    <template #tip>
                        <div class="el-upload__tip">僅允許 jpg / jpeg / png，最多 1 張（可不重新上傳）</div>
                    </template>
                </el-upload>
            </el-form-item>

            <el-form-item v-if="dialog.mode === 'edit'" label="狀態">
                <el-select v-model="form.status" style="width:100%;">
                    <el-option label="啟用" :value="statusValues.enabled"></el-option>
                    <el-option label="停用" :value="statusValues.disabled"></el-option>
                </el-select>
            </el-form-item>
        </el-form>

        <template #footer>
            <el-button v-on:click="dialog.visible=false">取消</el-button>
            <el-button type="primary" :loading="dialog.saving" v-on:click="saveDialog">儲存</el-button>
        </template>
    </el-dialog>
</div>

<style>
    .album-search-form {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px 16px;
    }

        /* 移除 el-form-item 預設下方間距 */
        .album-search-form .el-form-item {
            margin-bottom: 0;
        }

        /* 讓查詢按鈕群靠右 */
        .album-search-form .search-buttons {
            margin-left: auto;
        }

</style>

<script>
    const { createApp, reactive, ref, onMounted } = Vue;

    createApp({
        setup() {
            const loading = ref(false);
            const rows = ref([]);

            // Status enum：1=啟用, 0=停用
            const statusValues = {
                enabled: 1,
                disabled: 0
            };

            // 查詢條件
            const query = reactive({
                ownerAccountId: null,
                albumId: null,
                statusFilter: null // null=全部
            });

            // 分頁
            const pager = reactive({
                pageIndex: 1,
                pageSize: 10,
                total: 0
            });

            // Dialog
            const dialog = reactive({
                visible: false,
                mode: 'create', // create | edit
                saving: false
            });

            // Form
            const form = reactive({
                ownerAccountId: null, // 新增用參數
                albumPhotoId: null, // 更新用參數
                albumId: null, // 新增/更新用參數
                status: statusValues.enabled, // 新增/更新用參數
                sortOrder: 0
            });

            const createFileList = ref([]);
            const editFileList = ref([]);

            // 擁有人下拉選項=====================
            const ownerItems = ref([]);
            const ownerLoading = ref(false);
            const formOwnerItems = ref([]);
            const formOwnerLoading = ref(false);

            const apiOwner = axios.create({
              baseURL: '/Admin/Api/MemberAccountApi',
              headers: { 'Content-Type': 'application/json' }
            });

            async function loadOwnerItems() {
              ownerLoading.value = true;
              try {
                const resp = await apiOwner.get('/items');

                const arr = Array.isArray(resp.data) ? resp.data : (resp.data?.data ?? []);
                ownerItems.value = arr;

              } catch (e) {
                ElementPlus.ElMessage.error('載入擁有人失敗');
              } finally {
                ownerLoading.value = false;
              }
            }

            async function loadFormOwnerItems() {
              formOwnerLoading.value = true;
              try {
                const resp = await apiOwner.get('/items');

                const arr = Array.isArray(resp.data) ? resp.data : (resp.data?.data ?? []);
                formOwnerItems.value = arr;

              } catch (e) {
                ElementPlus.ElMessage.error('載入擁有人失敗');
              } finally {
                formOwnerLoading.value = false;
              }
            }
            // 擁有人下拉選項=====================
            // 相簿下拉選項=====================
            const albumItems = ref([]);
            const albumLoading = ref(false);
            const formAlbumItems = ref([]);
            const formAlbumLoading = ref(false);

            const apiAlbum = axios.create({
              baseURL: '/Admin/Api/AlbumApi',
              headers: { 'Content-Type': 'application/json' }
            });

            async function loadAlbumItems(ownerAccountId) {
              albumLoading.value = true;
              try {
                const params = {};
                if (ownerAccountId) {
                    params.ownerAccountId = ownerAccountId;
                }
                const resp = await apiAlbum.get('/items', { params });

                const arr = Array.isArray(resp.data) ? resp.data : (resp.data?.data ?? []);
                albumItems.value = arr;

              } catch (e) {
                ElementPlus.ElMessage.error('載入相簿失敗');
              } finally {
                albumLoading.value = false;
              }
            }

            async function loadFormAlbumItems(ownerAccountId) {
              formAlbumLoading.value = true;
              try {
                const params = {};
                if (ownerAccountId) {
                    params.ownerAccountId = ownerAccountId;
                }
                const resp = await apiAlbum.get('/items', { params });

                const arr = Array.isArray(resp.data) ? resp.data : (resp.data?.data ?? []);
                formAlbumItems.value = arr;

              } catch (e) {
                ElementPlus.ElMessage.error('載入相簿失敗');
              } finally {
                formAlbumLoading.value = false;
              }
            }
            // 相簿下拉選項=====================
            // 下拉選向連動=====================
            function onOwnerChanged(val) {
                query.albumId = null;
                loadAlbumItems(val);
            }
            function onFormOwnerChanged(val) {
                form.albumId = null;
                loadFormAlbumItems(val);
            }
            // 下拉選向連動=====================

            const apiJson = axios.create({
                baseURL: '/Admin/Api/AlbumPhotoApi',
                headers: { 'Content-Type': 'application/json' }
            });
            const apiForm = axios.create({
                baseURL: '/Admin/Api/AlbumPhotoApi'
            });

            function isEnabled(status) {
                return status === statusValues.enabled;
            }

            function buildSearchParams() {
                return {
                    pageIndex: pager.pageIndex,
                    pageSize: pager.pageSize,
                    'Data.OwnerAccountId': query.ownerAccountId || null,
                    'Data.AlbumId': query.albumId || null,
                    'Data.Status': query.statusFilter
                };
            }

            async function loadList() {
                loading.value = true;
                try {
                    const resp = await apiJson.get('', { params: buildSearchParams() });

                    const payload = resp.data || {};
                    rows.value = payload.data ?? payload.Data ?? [];
                    pager.total = payload.count ?? payload.Count ?? 0;
                } catch (e) {
                    ElementPlus.ElMessage.error('載入列表失敗');
                } finally {
                    loading.value = false;
                }
            }

            function onSearch() {
                pager.pageIndex = 1;
                loadList();
            }

            function resetQuery() {
                query.albumId = null;
                query.ownerAccountId = null;
                query.statusFilter = null;
                pager.pageIndex = 1;
                loadAlbumItems(null);
                loadList();
            }

            function onPageChange(page) {
                pager.pageIndex = page;
                loadList();
            }

            function onSizeChange(size) {
                pager.pageSize = size;
                pager.pageIndex = 1;
                loadList();
            }

            async function openCreate() {
                dialog.mode = 'create';
                form.ownerAccountId = null;
                form.albumPhotoId = null;
                form.albumId = null;
                form.status = statusValues.enabled;
                form.sortOrder = 0;
                // 重製上傳檔案
                createFileList.value = [];
                editFileList.value = [];

                await loadFormOwnerItems();

                dialog.visible = true;
            }

            async function openEdit(row) {
                dialog.mode = 'edit';
                
                // 重製上傳檔案
                createFileList.value = [];
                editFileList.value = [];

                dialog.visible = true;
                dialog.saving = false;
                try {
                    const resp = await apiJson.get(`/${row.albumPhotoId}/${row.albumId}`);
                    const dto = resp.data;

                    form.albumPhotoId = dto.albumPhotoId ?? dto.albumPhotoId;
                    form.albumId = dto.albumId ?? dto.albumId;
                    form.status = dto.status ?? dto.Status;
                    form.sortOrder = dto.sortOrder ?? dto.sortOrder;
                    if (dto.ownerAccountId) {
                        await loadFormAlbumItems(dto.ownerAccountId);
                    } else {
                        ElementPlus.ElMessage.error('讀取資料失敗');
                        dialog.visible = false;
                    }

                } catch (e) {
                    ElementPlus.ElMessage.error('讀取資料失敗');
                    dialog.visible = false;
                }
            }

            function beforeImageUpload(file) {
                const allowed = ['image/jpeg', 'image/png'];
                const ok = allowed.includes(file.type);
                if (!ok) {
                    ElementPlus.ElMessage.error('僅允許上傳 jpg / jpeg / png');
                }
                return ok;
            }

            function onCreateExceed() {
                ElementPlus.ElMessage.warning('最多只能上傳 5 張');
            }

            function onEditExceed() {
                ElementPlus.ElMessage.warning('更新時最多只能上傳 1 張');
            }

            function toFormData(obj) {
                const fd = new FormData();
                Object.entries(obj).forEach(([k, v]) => {
                    if (v === undefined || v === null) return;
                    fd.append(k, v);
                });
                return fd;
            }

            async function saveDialog() {

                dialog.saving = true;
                try {
                    if (dialog.mode === 'create') {
                        const fd = toFormData({
                              albumId: form.albumId
                        });

                        // 多檔：Files
                        createFileList.value.forEach(f => {
                            if (f?.raw) 
                                fd.append('Files', f.raw);
                        });

                        const { data: id } = await apiForm.post('', fd);
                        console.log(id);
                        ElementPlus.ElMessage.success('新增成功');
                        dialog.visible = false;
                        loadList();
                    } else {
                        const fd = toFormData({
                              albumPhotoId: form.albumPhotoId,
                              albumId: form.albumId,
                              sortOrder: form.sortOrder,
                              status: form.status
                        });

                        const f = editFileList.value?.[0];
                        if (f?.raw) 
                            fd.append('Files', f.raw);

                        const { data: ok } = await apiForm.put(`/${form.albumPhotoId}/${form.albumId}`, fd);
                        console.log(ok);
                        ElementPlus.ElMessage.success('更新成功');
                        dialog.visible = false;
                        loadList();
                    }
                } catch (e) {
                    console.log(e)
                    ElementPlus.ElMessage.error('儲存失敗（請檢查欄位或後端驗證）');
                } finally {
                    dialog.saving = false;
                }
            }

            async function confirmSetStatus(row, newStatus) {
                const actionText = (newStatus === statusValues.disabled) ? '停用' : '啟用';

                try {
                    await ElementPlus.ElMessageBox.confirm(
                        `確定要${actionText}「${row.title}」？`,
                        `${actionText}確認`,
                        { type: 'warning' }
                    );

                    const resp = await apiJson.patch(`/${row.albumPhotoId}/status`, {
                        status: newStatus
                    });

                    const ok = resp.data === true || resp.data === "true";
                    if (ok) {
                        row.status = newStatus;
                        ElementPlus.ElMessage.success(`${actionText}成功`);
                    } else {
                        ElementPlus.ElMessage.error(`${actionText}失敗`);
                    }
                } catch {
                    // cancel / ignore
                }
            }

            onMounted(async () => {
              await loadOwnerItems();
              // await loadAlbumItems(null);
              await loadList();
            });

            return {
                loading,
                rows,
                query,
                pager,
                dialog,
                form,
                statusValues,
                isEnabled,
                loadList,
                onSearch,
                resetQuery,
                onPageChange,
                onSizeChange,
                openCreate,
                openEdit,
                saveDialog,
                confirmSetStatus,
                ownerItems,
                ownerLoading,
                albumItems,
                albumLoading,
                onOwnerChanged,
                formOwnerItems,
                formOwnerLoading,
                formAlbumItems,
                formAlbumLoading,
                onFormOwnerChanged,
                beforeImageUpload,
                onCreateExceed,
                onEditExceed,
                createFileList,
                editFileList
            };
        }
    }).use(ElementPlus).mount('#app');
</script>



